import{D as i}from"./decimal-CNRKZ6of.js";const h="payroll_batches";let d=[],l=!1;function u(){if(!l){try{const a=localStorage.getItem(h);a&&(d=JSON.parse(a).map(t=>({...t,totalAmount:new i(t.totalAmount)})))}catch{}l=!0}}function m(){try{localStorage.setItem(h,JSON.stringify(d.map(a=>({...a,totalAmount:a.totalAmount.toString()}))))}catch{}}function f(a,n){return`PB-${n}-${String(a).padStart(2,"0")}-${Date.now().toString(36)}`}const g={list(){return u(),[...d]},getById(a){return u(),d.find(n=>n.id===a)},getDraft(a,n){return u(),d.find(t=>t.month===a&&t.year===n&&t.status==="draft")},createDraft(a,n){u();const t=this.getDraft(a,n);if(t)return t;const o={id:f(a,n),month:a,year:n,employees:[],attendance:{},calculations:[],totalAmount:new i(0),status:"draft",calculationMode:"Permanent",overtimeConfig:{regular:1.25,weekend:1.5,holiday:2},attendanceImportAudit:[]};return d.push(o),m(),o},upsert(a){u();const n=d.findIndex(t=>t.id===a.id);return n>=0?d[n]=a:d.push(a),m(),a},updateAttendance(a,n){u();const t=this.getById(a);if(!t)throw new Error("Batch not found");return t.attendance=n,this.upsert(t),t},updateCalculations(a,n){u();const t=this.getById(a);if(!t)throw new Error("Batch not found");return t.calculations=n,t.totalAmount=new i(n.reduce((o,r)=>o+r.net,0)),this.upsert(t),t},updateCalculationMode(a,n){u();const t=this.getById(a);if(!t)throw new Error("Batch not found");return t.calculationMode=n,this.upsert(t),t},updateOvertimeConfig(a,n){u();const t=this.getById(a);if(!t)throw new Error("Batch not found");return t.overtimeConfig={...t.overtimeConfig||{regular:1.25,weekend:1.5,holiday:2},...n},this.upsert(t),t.overtimeConfig},addAttendanceImportAudit(a,n){u();const t=this.getById(a);if(!t)throw new Error("Batch not found");return t.attendanceImportAudit=t.attendanceImportAudit||[],t.attendanceImportAudit.push({id:crypto.randomUUID(),at:new Date().toISOString(),...n}),this.upsert(t),t.attendanceImportAudit[t.attendanceImportAudit.length-1]},computeVersionHash(a){u();const n=this.getById(a);if(!n)throw new Error("Batch not found");const t={month:n.month,year:n.year,calculations:(n.calculations||[]).map(e=>({employeeId:e.employeeId,basic:e.basic,housing:e.housing,transport:e.transport,other:e.other,overtime:e.overtime,deductions:e.deductions,baseNet:e.baseNet??e.net-(e.adjustmentsTotal||0)})),adjustments:(n.adjustments||[]).map(e=>({id:e.id,employeeId:e.employeeId,type:e.type,amount:e.amount,reason:e.reason}))},o=JSON.stringify(t);let r=2166136261;for(let e=0;e<o.length;e++)r^=o.charCodeAt(e),r=r*16777619>>>0;return r.toString(16)},addAdjustment(a,n){u();const t=this.getById(a);if(!t)throw new Error("Batch not found");const o={...n,id:crypto.randomUUID(),appliedAt:new Date};if(t.adjustments=t.adjustments||[],t.adjustments.push(o),t.adjustmentAudit=t.adjustmentAudit||[],t.adjustmentAudit.push({action:"add",adjustmentId:o.id,at:new Date().toISOString(),details:{type:o.type,amount:o.amount}}),t.calculations){const r=new Map(t.calculations.map(e=>[e.employeeId,e]));t.calculations.forEach(e=>{e.baseNet==null&&(e.baseNet=e.net),e.adjustmentsTotal=0}),t.adjustments.forEach(e=>{const s=r.get(e.employeeId);if(!s)return;const c=e.type==="deduction"?-e.amount:e.amount;s.adjustmentsTotal=(s.adjustmentsTotal||0)+c,s.baseNet==null&&(s.baseNet=s.net),s.net=s.baseNet+(s.adjustmentsTotal||0)}),t.totalAmount=new i(t.calculations.reduce((e,s)=>e+s.net,0))}return this.upsert(t),o},removeAdjustment(a,n){u();const t=this.getById(a);!t||!t.adjustments||(t.adjustments=t.adjustments.filter(o=>o.id!==n),t.adjustmentAudit=t.adjustmentAudit||[],t.adjustmentAudit.push({action:"remove",adjustmentId:n,at:new Date().toISOString()}),t.calculations&&(t.calculations.forEach(o=>{o.baseNet!=null&&(o.net=o.baseNet),o.adjustmentsTotal=0}),t.adjustments.forEach(o=>{const r=t.calculations.find(s=>s.employeeId===o.employeeId);if(!r)return;const e=o.type==="deduction"?-o.amount:o.amount;r.adjustmentsTotal=(r.adjustmentsTotal||0)+e,r.baseNet==null&&(r.baseNet=r.net),r.net=r.baseNet+(r.adjustmentsTotal||0)}),t.totalAmount=new i(t.calculations.reduce((o,r)=>o+r.net,0))),this.upsert(t))},editAdjustment(a,n,t){u();const o=this.getById(a);if(!o||!o.adjustments)throw new Error("Batch not found");const r=o.adjustments.find(e=>e.id===n);if(!r)throw new Error("Adjustment not found");Object.assign(r,t,{editedAt:new Date}),o.adjustmentAudit=o.adjustmentAudit||[],o.adjustmentAudit.push({action:"edit",adjustmentId:n,at:new Date().toISOString(),details:t}),o.calculations&&(o.calculations.forEach(e=>{e.baseNet!=null&&(e.net=e.baseNet),e.adjustmentsTotal=0}),o.adjustments.forEach(e=>{const s=o.calculations.find(p=>p.employeeId===e.employeeId);if(!s)return;const c=e.type==="deduction"?-e.amount:e.amount;s.adjustmentsTotal=(s.adjustmentsTotal||0)+c,s.baseNet==null&&(s.baseNet=s.net),s.net=s.baseNet+(s.adjustmentsTotal||0)}),o.totalAmount=new i(o.calculations.reduce((e,s)=>e+s.net,0))),this.upsert(o)},approve(a){u();const n=this.getById(a);if(!n)throw new Error("Batch not found");return n.status="approved",this.upsert(n),n},markProcessed(a){u();const n=this.getById(a);if(!n)throw new Error("Batch not found");return n.status="processed",this.upsert(n),n}};export{g as P};
//# sourceMappingURL=payroll-Cm_R0hmF.js.map
