var R=Object.defineProperty;var C=(h,t,a)=>t in h?R(h,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):h[t]=a;var P=(h,t,a)=>C(h,typeof t!="symbol"?t+"":t,a);import{j as e}from"./vendor-ds6wDdAD.js";import{r as m}from"./react-nPrKd0zk.js";import{P as A}from"./payroll-Cm_R0hmF.js";import{E}from"./employees-D2MDJNGt.js";import{E as G,P as y,W as L}from"./jspdf.es.min-BojTXcBU.js";import{a as M,k as T}from"./index-sMHxiCIB.js";import"./decimal-CNRKZ6of.js";import"./employees-DNNZe7Q5.js";class f{static exportSingle(t){const a=new G({orientation:"portrait",unit:"mm",format:"a4"});this.drawPayslip(a,t,1,1),a.save(`Payslip-${t.employeeName.replace(/\s+/g,"_")}-${t.period.month}-${t.period.year}.pdf`)}static exportBatch(t){const a=y.list(t);if(!a.length)throw new Error("No payslips to export");const c=new G({orientation:"portrait",unit:"mm",format:"a4"});a.forEach((r,n)=>{n>0&&c.addPage(),this.drawPayslip(c,r,n+1,a.length)});const d=a[0];c.save(`Payslips-Batch-${t}-${d.period.month}-${d.period.year}.pdf`)}static drawPayslip(t,a,c,d){t.setFont("helvetica","bold"),t.setFontSize(14),t.text("PAYSLIP",this.PAGE_MARGIN_X,this.PAGE_MARGIN_TOP),t.setFontSize(8),t.setFont("helvetica","normal"),t.text(`Generated: ${typeof a.generatedAt=="string"?a.generatedAt:a.generatedAt.toLocaleString()}`,this.PAGE_MARGIN_X,this.PAGE_MARGIN_TOP+5);let r=this.PAGE_MARGIN_TOP+14;t.setFontSize(this.FONT_SIZE_BASE),t.setFont("helvetica","bold"),t.text(a.employeeName,this.PAGE_MARGIN_X,r),t.setFont("helvetica","normal"),r+=this.LINE_HEIGHT,t.text(`Employee ID: ${a.employeeId}`,this.PAGE_MARGIN_X,r),r+=this.LINE_HEIGHT,t.text(`Batch / Period: ${a.batchId}  (${a.period.month}/${a.period.year})`,this.PAGE_MARGIN_X,r),r+=this.LINE_HEIGHT,t.setFont("helvetica","bold"),t.text(`Gross: ${a.gross.toFixed(2)}`,this.PAGE_MARGIN_X,r),t.setFont("helvetica","normal"),t.text(`Deductions: ${a.deductions.toFixed(2)}`,this.PAGE_MARGIN_X+50,r),t.setFont("helvetica","bold"),t.text(`Net: ${a.net.toFixed(2)}`,this.PAGE_MARGIN_X+100,r),r+=this.LINE_HEIGHT+2;const n=[this.PAGE_MARGIN_X,this.PAGE_MARGIN_X+18,this.PAGE_MARGIN_X+96,this.PAGE_MARGIN_X+126];t.setFontSize(9),t.setFont("helvetica","bold"),t.text("Code",n[0],r),t.text("Description",n[1],r),t.text("Type",n[2],r,{align:"right"}),t.text("Amount",n[3],r,{align:"right"}),r+=2,t.setDrawColor(200),t.setLineWidth(.1),t.line(this.PAGE_MARGIN_X,r,195,r),r+=4,t.setFont("helvetica","normal"),t.setFontSize(8.5);const N=[...a.lines];N.sort((o,x)=>o.type===x.type?0:o.type==="earning"?-1:1),N.forEach(o=>{r>270&&(t.addPage(),c+=1,r=this.PAGE_MARGIN_TOP),t.text(o.code,n[0],r),this.wrapText(t,o.description,n[1],r,70,this.LINE_HEIGHT-1,u=>{r=u}),t.text(o.type,n[2],r,{align:"right"});const x=(o.type==="deduction"?"-":"")+o.amount.toFixed(2);t.text(x,n[3],r,{align:"right"}),r+=this.LINE_HEIGHT}),r>250&&(t.addPage(),c+=1,r=this.PAGE_MARGIN_TOP),t.setFont("helvetica","bold"),t.text(`Net Pay: ${a.net.toFixed(2)}`,this.PAGE_MARGIN_X,r+4),t.setFontSize(7),t.setFont("helvetica","normal"),t.text(`Page ${c} / ${d}`,200-this.PAGE_MARGIN_X,287,{align:"right"})}static wrapText(t,a,c,d,r,n,N){const o=a.split(/\s+/);let x="";o.forEach((u,b)=>{const j=x?x+" "+u:u;t.getTextWidth(j)>r?(t.text(x,c,d),d+=n,x=u):x=j,b===o.length-1&&t.text(x,c,d)}),N(d)}}P(f,"PAGE_MARGIN_X",14),P(f,"PAGE_MARGIN_TOP",16),P(f,"LINE_HEIGHT",6),P(f,"FONT_SIZE_BASE",10);function $(){const{search:h}=T();return m.useMemo(()=>new URLSearchParams(h),[h])}const V=()=>{const h=$(),t=M(),a=h.get("batch")||"",[c,d]=m.useState([]),[r,n]=m.useState(""),[N,o]=m.useState(""),[x,u]=m.useState([]),[b,j]=m.useState(null),[l,v]=m.useState(null);m.useEffect(()=>{var s;if(a)try{const i=A.getById(a);if(!i){j("Batch not found");return}!y.list(a).length&&((s=i.calculations)!=null&&s.length)&&y.generateForBatch(a),d([...y.list(a)])}catch(i){j(i.message)}},[a]),m.useEffect(()=>{(async()=>{const s=await E.getActiveEmployees();u(Array.from(new Set(s.filter(i=>i.employeeType==="Permanent").map(i=>i.employment.department))).sort())})()},[]);const _=()=>{if(!a)return;const s=y.exportCSV(a),i=new Blob([s],{type:"text/csv"}),g=URL.createObjectURL(i),p=document.createElement("a");p.href=g,p.download=`Payslips-${a}.csv`,p.click(),URL.revokeObjectURL(g)},S=async()=>{if(!a)return;const s=await L.exportCSV(a),i=new Blob([s],{type:"text/csv"}),g=URL.createObjectURL(i),p=document.createElement("a");p.href=g,p.download=`WPS-${a}.csv`,p.click(),URL.revokeObjectURL(g)},I=()=>{if(a)try{f.exportBatch(a)}catch(s){j(s.message)}},w=()=>{if(l)try{f.exportSingle(l)}catch(s){j(s.message)}},F=A.list().filter(s=>s.status!=="draft");return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Payslips"}),e.jsxs("select",{value:a,onChange:s=>t(`/payroll/payslips?batch=${s.target.value}`),className:"border rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"",children:"Select batch..."}),F.map(s=>e.jsxs("option",{value:s.id,children:[s.month,"/",s.year," - ",s.status]},s.id))]}),a&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:_,className:"px-3 py-1.5 text-xs rounded bg-blue-600 text-white",children:"Export Payslips CSV"}),e.jsx("button",{onClick:S,className:"px-3 py-1.5 text-xs rounded bg-indigo-600 text-white",children:"Export WPS CSV"}),e.jsx("button",{onClick:I,className:"px-3 py-1.5 text-xs rounded bg-emerald-600 text-white",children:"Export Payslips PDF"})]})]}),!a&&e.jsx("div",{className:"text-sm text-gray-600",children:"Select a processed batch to view payslips."}),b&&e.jsx("div",{className:"text-sm text-red-600",children:b}),a&&!b&&e.jsxs("div",{className:"space-y-3",children:[y.isOutdated(a)&&e.jsxs("div",{className:"text-xs bg-amber-50 border border-amber-300 text-amber-800 px-3 py-2 rounded flex items-center justify-between",children:[e.jsx("span",{children:"Payslips are outdated due to calculation/adjustment changes. Regenerate to refresh."}),e.jsx("button",{className:"text-xs font-medium underline",onClick:()=>{y.clearBatch(a),y.generateForBatch(a),d([...y.list(a)])},children:"Regenerate"})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[11px] font-medium mb-1",children:"Search"}),e.jsx("input",{value:r,onChange:s=>n(s.target.value),placeholder:"Employee name...",className:"border rounded px-2 py-1 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[11px] font-medium mb-1",children:"Department"}),e.jsxs("select",{value:N,onChange:s=>o(s.target.value),className:"border rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"",children:"All"}),x.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsx("div",{className:"overflow-x-auto border rounded bg-white",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Employee"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Gross"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Deductions"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Net"}),e.jsx("th",{className:"px-3 py-2"})]})}),e.jsxs("tbody",{children:[c.filter(s=>!r||s.employeeName.toLowerCase().includes(r.toLowerCase())).filter(s=>!N||(()=>{var g,p;const i=(p=(g=E).getById)==null?void 0:p.call(g,s.employeeId);return(i==null?void 0:i.employeeType)==="Permanent"&&i.employment.department===N})()).map(s=>e.jsxs("tr",{className:"border-b last:border-0",children:[e.jsx("td",{className:"px-3 py-2 font-medium",children:s.employeeName}),e.jsx("td",{className:"px-3 py-2 text-right",children:s.gross.toFixed(2)}),e.jsx("td",{className:"px-3 py-2 text-right text-red-600",children:s.deductions.toFixed(2)}),e.jsx("td",{className:"px-3 py-2 text-right font-semibold text-green-600",children:s.net.toFixed(2)}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsx("button",{className:"text-blue-600 text-xs hover:underline",onClick:()=>v(s),children:"View"})})]},s.id)),c.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-6 text-center text-gray-500",children:"No payslips generated."})})]})]})})]}),l&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50",onClick:()=>v(null),children:e.jsxs("div",{className:"bg-white rounded shadow max-w-lg w-full",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsxs("h2",{className:"font-semibold text-sm",children:["Payslip: ",l.employeeName]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:w,className:"text-xs px-2 py-1 rounded bg-emerald-600 text-white",children:"PDF"}),e.jsx("button",{onClick:()=>v(null),className:"text-xs",children:"Close"})]})]}),e.jsxs("div",{className:"p-4 max-h-[60vh] overflow-auto text-xs space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-y-1",children:[e.jsx("span",{className:"text-gray-500",children:"Batch:"}),e.jsx("span",{children:l.batchId}),e.jsx("span",{className:"text-gray-500",children:"Period:"}),e.jsxs("span",{children:[l.period.month,"/",l.period.year]}),e.jsx("span",{className:"text-gray-500",children:"Generated:"}),e.jsx("span",{children:typeof l.generatedAt=="string"?l.generatedAt:l.generatedAt.toLocaleString()})]}),e.jsxs("table",{className:"w-full text-xs border",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-1 text-left",children:"Code"}),e.jsx("th",{className:"px-2 py-1 text-left",children:"Description"}),e.jsx("th",{className:"px-2 py-1 text-right",children:"Type"}),e.jsx("th",{className:"px-2 py-1 text-right",children:"Amount"})]})}),e.jsx("tbody",{children:l.lines.map(s=>e.jsxs("tr",{className:"border-b last:border-0",children:[e.jsx("td",{className:"px-2 py-1 font-mono text-[11px]",children:s.code}),e.jsx("td",{className:"px-2 py-1",children:s.description}),e.jsx("td",{className:"px-2 py-1 text-right capitalize {l.type==='deduction'?'text-red-600':''}",children:s.type}),e.jsxs("td",{className:`px-2 py-1 text-right ${s.type==="deduction"?"text-red-600":"text-gray-700"}`,children:[s.type==="deduction"&&"-",s.amount.toFixed(2)]})]},s.code+s.description+s.amount))}),e.jsxs("tfoot",{className:"bg-gray-50 font-medium",children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-2 py-1",colSpan:3,children:"Gross"}),e.jsx("td",{className:"px-2 py-1 text-right",children:l.gross.toFixed(2)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-2 py-1",colSpan:3,children:"Deductions"}),e.jsx("td",{className:"px-2 py-1 text-right text-red-600",children:l.deductions.toFixed(2)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-2 py-1",colSpan:3,children:"Net"}),e.jsx("td",{className:"px-2 py-1 text-right font-semibold text-green-600",children:l.net.toFixed(2)})]})]})]})]})]})})]})};export{V as PayslipsPage,V as default};
//# sourceMappingURL=Payslips-De5Fbhze.js.map
